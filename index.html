<!DOCTYPE html>
<html lang="en">
<head>
    <title>COVID-19 USA DATA TRACKER</title>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="js/d3_annotation.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font: 11px sans-serif;
            background-color: #ffffff;
            background-image: url('img/COVID19.jpg');
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-size: 100% 100%;
        }

        .header h1 {
            height: 10px;
            top: 18px;
            left: 10px;
        }

        /* Style the top navigation bar */
        .topnav {
            overflow: hidden;
            background-color: #5a6ddc;
        }

        /* Style the topnav links */
        .topnav a {
            float: left;
            display: block;
            color: #f2f2f2;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
        }

        /* Change color on hover */
        .topnav a:hover {
            background-color: #ddd;
            color: black;
        }

        /* Create three unequal columns that floats next to each other */
        .column {
            float: left;
            padding: 10px;
        }

        /* Left and right column */
        .column.side {
            width: 25%;
        }

        /* Middle column */
        .column.middle {
            width: 100%;
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
            gap: 0px;
        }

        /* Responsive layout - makes the three columns stack on top of each other instead of next to each other */
        @media screen and (max-width: 600px) {
            .column.middle {
                width: 100%;
            }
        }

        .tooltip {
            placement: auto;
            position: absolute;
            display:inline;
            overflow:auto;
            font-size: 15px;
            width:  auto;
            height: auto;
            pointer-events: none;
            background-color: antiquewhite;
            color: midnightblue;
            padding: 0.3px;
        }

        /* Style the footer */
        .footer {
            background-color: #f1f1f1;
            padding: 10px;
            text-align: center;
        }

        .container{
            position: center;
            margin: 1px;
            width: 100%;
        }
    </style>
</head>
<body>

<div class="header">
    <h1 style="text-align:center;color:floralwhite;font-family:courier;font-size:250%">COVID-19 USA DATA TRACKER</h1>
</div>
<br>

<div class="body">
     <div class="container">
        <div class="topnav">
            <a href="index.html">HOME</a>
            <a href="US_STATE_CASES_DEATHS.html">U.S. STATE DATA</a>
            <a href="Demographic.html">DEMOGRAPHIC DATA</a>
            <a href="CASES_DEATHS_TREND.html">TREND DATA</a>
        </div>
     </div>

<div class="row">
    <div class="column middle">
        <p style="background-color:antiquewhite;font-family:Helvetica Neue;font-size:130%" align="justify"><b style="color: purple;font-size: 20px">COVID-19 Cases USA Map:</b><br>This map shows COVID-19 cases reported by U.S. states as of 07/15/2019.Latest surge of COVID-19 cases in Texas , Arizona , Florida and Illinois reflected on the map.<br><br> Hover over the maps to see the following details â€“ a) number of cumulative cases, b) number of cumulative cases per 100k population, c) number of cumulative deaths and d) number of cumulative deaths per 100k population reported in each jurisdiction. Legend scale on the top-left side shows the linear variation of total COVID-19 cases reported in U.S. states.<br></p>
        <div id="my_dataviz" style="background-color:#d7d4cc;color:#202c42;padding:10px;border: 5px outset #08080e" >
        </div>
    <p style="background-color:antiquewhite;font-family:Helvetica Neue;font-size:130%" align="justify"><b style="color: purple;font-size: 20px">Daily New Cases Trend in USA:</b><br> The following chart shows the number of new COVID-19 cases reported each day in the U.S. since mid-March when the outbreak was officially declared in the United States. Click buttons to switch between the trend of daily new counts and 7-day average data.<br> The 7-Day moving average of new cases (current day + 6 preceding days / 7) was calculated to smooth expected variations in daily counts. Additionally, hover over the bars to see the number of new cases by day and check the annotation to explore the recent exponential surge started from mid-June due to aggressive reopening strategy carried out by a few U.S. jurisdictions.<br></p>
    <div id="my_dataviz4" style="background-color:#d7d4cc;color:#202c42;padding:10px;border: 5px outset #08080e">
        <div><button onclick="update('Cases')">Cases</button>
            <button onclick="update('Average_7Day')">Average_7Day</button></div>
         </div>
    </div>
</div>
<br>
<footer>
    <p style="background-color:#ffffff;font-family:Helvetica Neue;font-size:130%" align="justify">
        <b>Reference:</b> For more information about COVID-19 disease please visit <a href="https://www.cdc.gov/coronavirus/2019-nCoV/index.html">https://www.cdc.gov/coronavirus/2019-nCoV/index.html</a>
        <br>
        <b>Data Courtesy:</b><a href="https://www.cdc.gov/"> https://www.cdc.gov/</a>
        <br>
        <b>Image Courtesy:</b><a href="https://phil.cdc.gov/Details.aspx?pid=23311"> https://phil.cdc.gov/Details.aspx?pid=23311</a>
        <br>
        <b>Viz creator:</b> Soumava Dey<br></p>
</footer>
</div>

<script type="text/javascript">

    ////////////////////////////////////// Beginning of USA Map code ///////////////////////////////////////////////////////
    //Width and height of map
    var width = 1200;
    var height = 550;

    var lowColor = '#7eee73'
    //var midColor = '#02235c'
    var highColor = '#cb010f'

    // D3 Projection
    var projection = d3.geoAlbersUsa()
        .translate([width / 1.7, height / 2]) // translate to center of screen
        .scale([1200]); // scale things down so see entire US

    // Define path generator
    var path = d3.geoPath() // path generator that will convert GeoJSON to SVG paths
        .projection(projection); // tell path generator to use albersUsa projection

    //Create SVG element and append map to the SVG
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width)
        .attr("height", height);


    // Load in my states data!
    d3.csv("data/US_STATE.csv", function(data) {
        var dataArray = [];
        for (var d = 0; d < data.length; d++) {
            dataArray.push(parseFloat(data[d].Total_Cases))
        }
        var minVal = d3.min(dataArray)
        //var midVal = (d3.max(dataArray) - d3.min(dataArray)) / 2
        var maxVal = d3.max(dataArray)
        //var ramp = d3.scaleLinear().domain([minVal,midVal,maxVal]).range([lowColor,midColor,highColor])
        var ramp = d3.scaleLinear().domain([minVal,maxVal]).range([lowColor,highColor])
        var tooltip = d3.select("#my_dataviz").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        // Load GeoJSON data and merge with states data
        d3.json("json/us-states.json", function(json) {

            // Loop through each state data value in the .csv file
            for (var i = 0; i < data.length; i++) {

                // Grab State Name
                var dataState = data[i].state;

                // Grab data value
                var dataValue = data[i].value;

                var dataValue1 = data[i].Death_100k;

                var dataValue2 = data[i].Total_Cases;

                var dataValue3 = data[i].RatePer100000;

                // Find the corresponding state inside the GeoJSON
                for (var j = 0; j < json.features.length; j++) {
                    var jsonState = json.features[j].properties.NAME;
                    if (dataState == jsonState) {


                        // Copy the data value into the JSON
                        json.features[j].properties.value = dataValue;

                        json.features[j].properties.death_100k = dataValue1;

                        json.features[j].properties.total_cases = dataValue2;

                        json.features[j].properties.cases_100k = dataValue3;

                        // Stop looking through the JSON
                        break;
                    }
                }
            }

            // Bind the data to the SVG and create one path per GeoJSON feature
            svg.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", path)
                .style("stroke", "#03243d")
                .style("stroke-width", "1")
                .style("fill", function(d) { return ramp(d.properties.total_cases) })
                .on("mouseover", function(d) {
                    var html  = "<span><b> State : </b><b>" + d.properties.NAME + "</b></span><br/>" +
                        "<span style='color:indianred'><b> Total Cases: </b>" + d.properties.total_cases + "</span></br>" +
                        "<span style='color:darkred'><b> Cases per 100k: </b>" + d.properties.cases_100k + "</span></br>" +
                        "<span style='color:red'><b> Total Deaths: </b>" + d.properties.value + "</span></br>" +
                        "<span style='color:palevioletred'><b> Deaths per 100k: </b>" + d.properties.death_100k + "</span></br>"

                    ;

                    tooltip.html(html)
                        .style("left", (d3.event.pageX + 15) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                        .transition()
                        .duration(200) // ms
                        .style("opacity", .9) // started as 0!

                })

                // fade out tooltip on mouse out
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });


            // add a legend
            var l_w = 140, l_h = 500;

            var key = d3.select("#my_dataviz")
                .append("svg")
                .attr("width", l_w)
                .attr("height", l_h)
                .attr("class", "legend");

            var legend = key.append("defs")
                .append("svg:linearGradient")
                .attr("id", "gradient")
                .attr("x1", "100%")
                .attr("y1", "0%")
                .attr("x2", "100%")
                .attr("y2", "100%")
                .attr("spreadMethod", "pad");

            legend.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", highColor)
                .attr("stop-opacity", 1);

            legend.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", lowColor)
                .attr("stop-opacity", 1);

            key.append("rect")
                .attr("width", l_w - 100)
                .attr("height", l_h/2)
                .style("fill", "url(#gradient)")
                .attr("transform", "translate(49,0)");


            var y = d3.scaleLinear()
                .range([l_h/2, 0])
                .domain([0, maxVal]);

            var yAxis = d3.axisRight(y);

            key.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(90,0)")
                .call(yAxis)

        });
    });

    ////////////////////////////////////// Beginning of USA Daily New Cases Trend code //////////////////////////////

    // set the dimensions and margins of the graph
    var margin_daily = {top: 40, right: 20, bottom: 70, left: 40},
        width_daily = 1200 - margin_daily.left - margin_daily.right,
        height_daily = 600 - margin_daily.top - margin_daily.bottom;

    var annotations_daily = [
        {
            note: {
                title: "COVID cases surge from mid-June",
                align: "right"
            },
            type: d3.annotationCalloutCircle,
            subject: {
                radius: 150,
            },
            connector: {
                end: "arrow",        // Can be none, or arrow or dot
                type: "line",      // ?? don't know what it does
                lineType : "vertical",    // ?? don't know what it does
                endScale: 1    // dot size
            },
            color: ["red"],
            x: 950,
            y: 200,
            dy: -50,
            dx: -200
        }
    ]

    // Add annotation to the chart
    var makeAnnotationsRight_daily = d3.annotation()
        .annotations(annotations_daily)

    // append the svg object to the body of the page
    var svg_daily = d3.select("#my_dataviz4")
        .append("svg")
        .attr("width", width_daily + margin_daily.left + margin_daily.right)
        .attr("height", height_daily + margin_daily.top + margin_daily.bottom)
        .append("g")
        .call(makeAnnotationsRight_daily)
        .attr("transform",
            "translate(" + margin_daily.left + "," + margin_daily.top + ")");

    // Initialize the X axis
    var x = d3.scaleBand()
        .range([ 0, width_daily ])
        .padding(0.3);
    var xAxis = svg_daily.append("g")
        .attr("transform", "translate(0," + height_daily + ")")



    // Initialize the Y axis
    var y = d3.scaleLinear()
        .range([ height_daily, 0]);
    var yAxis = svg_daily.append("g")
        .attr("class", "myYaxis")


    var tooltip = d3.select("#my_dataviz4").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);



    // A function that create / update the plot for a given variable:
    function update(selectedVar) {

        // Parse the Data
        d3.csv("data/US_Daily_New_Case.csv", function(data) {

            // X axis
            x.domain(data.map(function(d) { return d.Date; }))
            xAxis.transition().duration(1000).call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-15,10)rotate(-90)")
                .style("text-anchor", "end");




            // Add Y axis
            y.domain([0, d3.max(data, function(d) { return +d[selectedVar] }) ]);
            yAxis.transition().duration(1000).call(d3.axisLeft(y));


            // variable u: map data to existing bars
            var u3 = svg_daily.selectAll("rect")
                .data(data)
                .on("mouseover", function(d) {
                    var html  = "<span><b> Date : </b>" + d.Date+ "</span><br/>" +
                        "<b style='color: darkred'> Total Cases: <b/>" + d[selectedVar];

                    tooltip.html(html)
                        .style("left", (d3.event.pageX + 25) + "px")
                        .style("top", (d3.event.pageY - 28) + "px")
                        .transition()
                        .duration(200) // ms
                        .style("opacity", .9) // started as 0!

                })

                // fade out tooltip on mouse out
                .on("mouseout", function(d) {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                })

            // update bars
            u3
                .enter()
                .append("rect")
                .merge(u3)
                .transition()
                .duration(1000)
                .attr("x", function(d) { return x(d.Date); })
                .attr("y", function(d) { return y(d[selectedVar]); })
                .attr("width", x.bandwidth())
                .attr("height", function(d) { return height_daily - y(d[selectedVar]); })
                .attr("fill", "#69b3a2")



        })

    }
    update('Cases')

    ////////////////////////////////////// End of USA Daily New Cases Trend code //////////////////////////////
</script>

</body>
</html>
